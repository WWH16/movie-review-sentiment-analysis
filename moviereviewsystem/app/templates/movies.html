{% extends "base.html" %}

{% block title %}Browse Movies{% endblock %}

{% block extra_css %}
<style>
    .search-section {
        background-color: var(--secondary-black);
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 40px;
        border: 1px solid rgba(253, 185, 19, 0.1);
    }

    .search-wrapper {
        position: relative;
        max-width: 600px;
        margin: 0 auto;
    }

    .search-input {
        background-color: var(--primary-black);
        border: 1px solid rgba(253, 185, 19, 0.3);
        color: var(--text-light);
        padding: 15px 50px 15px 20px;
        font-size: 1rem;
        border-radius: 50px;
        width: 100%;
    }

    .search-input:focus {
        border-color: var(--accent-yellow);
        box-shadow: 0 0 0 0.2rem rgba(253, 185, 19, 0.15);
        background-color: var(--primary-black);
        color: var(--text-light);
    }

    .search-icon {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--accent-yellow);
    }

    .filter-tabs {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        overflow-x: auto;
        padding-bottom: 10px;
    }

    .filter-tab {
        padding: 10px 25px;
        background-color: var(--secondary-black);
        border: 1px solid rgba(253, 185, 19, 0.2);
        border-radius: 25px;
        color: var(--text-light);
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .filter-tab:hover {
        border-color: var(--accent-yellow);
        background-color: rgba(253, 185, 19, 0.1);
    }

    .filter-tab.active {
        background-color: var(--accent-yellow);
        color: var(--bg-dark);
        border-color: var(--accent-yellow);
    }

    .movie-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
    }

    .movie-card {
        position: relative;
        cursor: pointer;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        background-color: var(--secondary-black);
    }

    .movie-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 8px 25px rgba(253, 185, 19, 0.3);
    }

    .movie-poster {
        width: 100%;
        aspect-ratio: 2/3;
        object-fit: cover;
        display: block;
        background-color: var(--primary-black);
    }

    .movie-poster.loading {
        background: linear-gradient(
            90deg,
            var(--primary-black) 25%,
            var(--secondary-black) 50%,
            var(--primary-black) 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }

    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .movie-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
        padding: 15px;
        transform: translateY(100%);
        transition: transform 0.3s ease;
    }

    .movie-card:hover .movie-overlay {
        transform: translateY(0);
    }

    .movie-title {
        color: #ffffff;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 5px;
        line-height: 1.3;
    }

    .movie-year {
        color: var(--accent-yellow);
        font-size: 0.85rem;
        font-weight: 500;
    }

    .movie-rating {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.8);
        color: var(--accent-yellow);
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 3px;
    }

    .no-poster {
        width: 100%;
        aspect-ratio: 2/3;
        background: linear-gradient(135deg, var(--primary-black), var(--secondary-black));
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: var(--text-muted);
    }

    .no-poster .material-icons {
        font-size: 48px;
        margin-bottom: 10px;
        color: rgba(253, 185, 19, 0.3);
    }

    .loading-spinner {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
    }

    .loading-spinner .spinner-border {
        border-color: var(--accent-yellow);
        border-right-color: transparent;
    }

    @media (max-width: 768px) {
        .movie-grid {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }

        .filter-tabs {
            gap: 10px;
        }
    }
</style>
{% endblock %}

{% block header %}
<h1>Browse Movies</h1>
<p class="mb-0">Select a movie to write your review</p>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Search Section -->
        <div class="search-section">
            <div class="search-wrapper">
                <input
                    type="text"
                    class="form-control search-input"
                    id="searchInput"
                    placeholder="Search for movies or TV series..."
                    onkeyup="filterMovies()"
                >
                <span class="material-icons search-icon">search</span>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <div class="filter-tab active" onclick="filterByCategory('all')">All</div>
            <div class="filter-tab" onclick="filterByCategory('movies')">Movies</div>
            <div class="filter-tab" onclick="filterByCategory('series')">TV Series</div>
            <div class="filter-tab" onclick="filterByCategory('popular')">Popular</div>
            <div class="filter-tab" onclick="filterByCategory('top-rated')">Top Rated</div>
        </div>

        <!-- Movie Grid -->
        <div class="movie-grid" id="movieGrid">
            <!-- Movies will be loaded here dynamically -->
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading movies...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const TMDB_API_KEY = '7b995d3c6fd91a2284b4ad8cb390c7b8';
    const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w500';
    let allMovies = [];
    let currentFilter = 'all';

    // Load movies on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadMovies();
    });

    async function loadMovies() {
        try {
            // TODO: Replace this with your Django API endpoint that returns your movie dataset
            // Example: fetch('/api/movies/')

            // For now, we'll fetch popular movies from TMDb as demonstration
            const response = await fetch(
                `https://api.themoviedb.org/3/movie/popular?api_key=${TMDB_API_KEY}&language=en-US&page=1`
            );
            const data = await response.json();
            allMovies = data.results;

            // Hide loading spinner
            document.getElementById('loadingSpinner').style.display = 'none';

            // Display movies
            displayMovies(allMovies);
        } catch (error) {
            console.error('Error loading movies:', error);
            document.getElementById('loadingSpinner').innerHTML =
                '<p class="text-danger">Error loading movies. Please try again.</p>';
        }
    }

    function displayMovies(movies) {
        const movieGrid = document.getElementById('movieGrid');
        movieGrid.innerHTML = '';

        if (movies.length === 0) {
            movieGrid.innerHTML = '<p class="text-center text-muted">No movies found</p>';
            return;
        }

        movies.forEach(movie => {
            const movieCard = createMovieCard(movie);
            movieGrid.appendChild(movieCard);
        });
    }

    function createMovieCard(movie) {
        const card = document.createElement('div');
        card.className = 'movie-card';
        card.onclick = () => selectMovie(movie);

        const posterUrl = movie.poster_path
            ? `${TMDB_IMAGE_BASE}${movie.poster_path}`
            : null;

        const year = movie.release_date
            ? new Date(movie.release_date).getFullYear()
            : 'N/A';

        const rating = movie.vote_average
            ? movie.vote_average.toFixed(1)
            : 'N/A';

        card.innerHTML = `
            ${posterUrl
                ? `<img src="${posterUrl}" alt="${movie.title}" class="movie-poster" loading="lazy">`
                : `<div class="no-poster">
                    <span class="material-icons">movie</span>
                    <span class="text-center px-2">${movie.title}</span>
                   </div>`
            }
            ${rating !== 'N/A' ? `<div class="movie-rating">
                <span class="material-icons" style="font-size: 16px;">star</span>
                ${rating}
            </div>` : ''}
            <div class="movie-overlay">
                <div class="movie-title">${movie.title}</div>
                <div class="movie-year">${year}</div>
            </div>
        `;

        return card;
    }

    function selectMovie(movie) {
        // TODO: Navigate to movie detail page or review page
        // For Django: window.location.href = `/movie/${movie.id}/review/`;

        // For now, show alert
        console.log('Selected movie:', movie);

        // Store movie data in sessionStorage to use on review page
        sessionStorage.setItem('selectedMovie', JSON.stringify(movie));

        // Navigate to review page (update with your Django URL)
        window.location.href = '/review/';
    }

    function filterMovies() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allMovies.filter(movie =>
            movie.title.toLowerCase().includes(searchTerm)
        );
        displayMovies(filtered);
    }

    async function filterByCategory(category) {
        currentFilter = category;

        // Update active tab
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');

        // Show loading
        document.getElementById('movieGrid').innerHTML = '';
        document.getElementById('loadingSpinner').style.display = 'block';

        try {
            let endpoint = '';

            switch(category) {
                case 'movies':
                    endpoint = `https://api.themoviedb.org/3/movie/popular?api_key=${TMDB_API_KEY}`;
                    break;
                case 'series':
                    endpoint = `https://api.themoviedb.org/3/tv/popular?api_key=${TMDB_API_KEY}`;
                    break;
                case 'popular':
                    endpoint = `https://api.themoviedb.org/3/trending/all/week?api_key=${TMDB_API_KEY}`;
                    break;
                case 'top-rated':
                    endpoint = `https://api.themoviedb.org/3/movie/top_rated?api_key=${TMDB_API_KEY}`;
                    break;
                default:
                    endpoint = `https://api.themoviedb.org/3/movie/popular?api_key=${TMDB_API_KEY}`;
            }

            const response = await fetch(endpoint);
            const data = await response.json();
            allMovies = data.results;

            document.getElementById('loadingSpinner').style.display = 'none';
            displayMovies(allMovies);
        } catch (error) {
            console.error('Error filtering movies:', error);
        }
    }

    // TODO: When integrating with Django backend:
    // 1. Replace TMDb API calls with your Django API endpoint
    // 2. Your Django endpoint should return movie data from your dataset
    // 3. For each movie, fetch poster from TMDb using the movie title
    // 4. Cache posters in your database for faster loading
</script>
{% endblock %}